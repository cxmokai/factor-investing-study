# 编程实践计划

> **目标：** 用 Python + Jupyter 实现因子投资的完整流程——从获取数据到构建可回测的多因子策略
> **时间：** 20 天，每天 2 小时
> **前提：** 已完成金融知识、数学复习、因子投资三个理论计划

---

## 这个计划和前三个计划的关系

```
金融知识（11天）→ 回答"为什么"
数学复习（10天）→ 回答"用什么工具"
因子投资（14天）→ 回答"怎么做"

编程实践（20天）→ 回答"代码怎么写"  ← 你现在在这里
  把前面学的所有东西变成可运行的代码
```

前三个计划的所有理论，最终都要在这里落地。每一天的代码都对应前面某个模块的知识点——你不需要重新学理论，只需要把已经理解的概念翻译成代码。

---

## 工具链

| 工具 | 用途 | 安装时间 |
|------|------|---------|
| asdf | Python 版本管理 | Day 1 |
| uv | 包管理 + 虚拟环境 | Day 1 |
| Jupyter Notebook | 每日研究环境 | Day 1 |
| pandas / numpy | 数据处理 | Day 1 |
| matplotlib / seaborn | 可视化 | Day 1 |
| akshare | A 股数据获取 | Day 1 |
| ccxt | 加密市场数据获取 | Day 2 |
| statsmodels | 回归分析、Newey-West 标准误 | Day 4 |
| scipy | 假设检验、优化 | Day 4 |
| scikit-learn | PCA、协方差收缩估计 | Day 5 |
| cvxpy | 组合优化（备选） | Day 17 |

> **依赖安装原则：** 用到哪天装哪天，不提前装。每天开头用 `uv add` 安装当天新增的库。

---

## 模块一：环境搭建与数据管道（Day 1-3）

**目标：** 能稳定获取 A 股和加密市场数据，产出干净的收益率矩阵

> 对应理论：金融知识 Day 1-4（市场结构、交易规则）

### Day 1：环境搭建 + A 股数据获取

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 项目初始化：`uv init`、安装基础依赖（pandas, numpy, matplotlib, seaborn, jupyter, akshare）、启动 Jupyter、Git 初始化 | — |
| 1h | 用 akshare 获取数据：沪深 300 成分股列表、个股日频行情（开高低收、成交量、换手率）、基础财务数据（PE、PB、ROE）。存储为 CSV 或 Parquet | 金融 Day 1-2 |

**产出：** 项目骨架 + A 股原始数据文件

### Day 2：加密市场数据 + 数据存储

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | `uv add ccxt`，用 ccxt 连接 Binance 获取 Top 50 加密货币日频 K 线数据（OHLCV）。处理交易所 API 限流和分页 | 金融 Day 3-4 |
| 1h | 设计统一的数据存储结构（按市场/频率/数据类型组织目录），编写数据加载函数，确保 A 股和加密数据用相同接口读取 | — |

**产出：** 加密市场原始数据 + 统一的数据读取模块

### Day 3：收益率计算与数据清洗

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 计算日/周/月收益率（简单收益率和对数收益率），处理复权价格，画收益率分布直方图，验证"肥尾"现象 | 数学 Day 3（正态分布、肥尾） |
| 1h | A 股数据清洗：剔除 ST 股、上市不满 6 个月、停牌日处理、涨跌停标记。加密数据清洗：剔除日成交额过低的币种、处理退市币种（生存偏差意识） | 因子 Day 11（前视偏差、生存偏差） |

**产出：** 干净的收益率矩阵（A 股 + 加密），可直接用于后续因子研究

**做完能验证：**
- `data/` 目录下有完整的原始数据和清洗后数据
- 能一行代码加载任意股票/币种的月收益率序列
- 收益率分布图确实呈现肥尾

---

## 模块二：统计工具实现（Day 4-5）

**目标：** 把数学计划中学的统计方法变成可调用的函数

> 对应理论：数学 Day 5-7（假设检验、回归、Newey-West）+ 数学 Day 9-10（优化、PCA）

### Day 4：回归分析与假设检验

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | `uv add statsmodels scipy`。用 statsmodels 对一只股票做 CAPM 回归（R_i - R_f = α + β(R_m - R_f) + ε），解读完整输出：α、β、t 值、p 值、R²。对比普通标准误和 Newey-West 标准误的差异 | 数学 Day 6-7 + 金融 Day 9 |
| 1h | 用 scipy.stats 做 t 检验和正态性检验（Shapiro-Wilk）。实现一个"生成 1000 个纯噪声因子，展示多重检验虚假发现"的演示 | 数学 Day 5 + 因子 Day 3 |

### Day 5：PCA 与优化基础

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | `uv add scikit-learn`。对 A 股收益率矩阵做 PCA，画出解释方差比，验证"第一主成分 ≈ 市场因子"。用 Ledoit-Wolf 收缩估计协方差矩阵，对比样本协方差 | 数学 Day 2, 10 |
| 1h | 用 scipy.optimize 实现最简单的均值-方差优化（5 只股票，最大化夏普比率），加入约束条件（权重非负、权重之和 = 1）。画出有效前沿 | 数学 Day 9 + 金融 Day 7 |

**做完能验证：**
- CAPM 回归输出能逐行解释每个数字的含义
- PCA 第一主成分和沪深 300 的相关系数 > 0.9
- 有效前沿图形正确（向上凸的曲线）

---

## 模块三：因子研究框架（Day 6-8）⭐ 核心

**目标：** 搭建可复用的因子分析工具包——之后每个新因子只需几行代码即可完成全套分析

> 对应理论：因子 Day 1-3（排序法、Fama-MacBeth、因子评估标准）

### Day 6：因子预处理

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 实现因子预处理三件套：(1) 去极值（MAD 法或 winsorize），(2) 标准化（z-score），(3) 缺失值处理。用市值数据验证每一步的效果（画分布图对比处理前后） | 因子 Day 1（因子流程第 3 步） |
| 1h | 实现行业中性化：在每个行业内部做 z-score。获取行业分类数据（中信一级或申万一级），验证中性化后因子的行业分布是否均匀 | 因子 Day 13（行业中性） |

### Day 7：IC 分析模块

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 实现 IC（Information Coefficient）计算：每月截面上因子值与下期收益率的 Spearman 秩相关。统计量：IC 均值、IC 标准差、IC_IR（= IC 均值 / IC 标准差）、IC > 0 的比率 | 因子 Day 1-2 |
| 1h | 实现 IC 可视化：IC 时间序列图、IC 柱状图、IC 累计曲线。封装成一个函数：输入因子值 DataFrame + 收益率 DataFrame → 输出全套 IC 统计和图表 | 因子 Day 1-2 |

### Day 8：分组回测模块 + 绩效指标

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 实现分组回测：按因子值排序 → 等分 N 组 → 每组等权持有 → 月度调仓 → 计算各组累计收益。输出：各组净值曲线、多空组合（第 1 组 - 第 N 组）净值曲线、单调性检验 | 因子 Day 1（排序法的 10 个步骤） |
| 1h | 实现绩效指标函数：年化收益率、年化波动率、夏普比率、最大回撤、Calmar 比率、信息比率。封装成标准输出格式（表格 + 图表） | 因子 Day 12（绩效评估） |

**做完能验证：**
- 对任意因子调用 3 行代码即可产出完整的 IC 报告和分组回测报告
- 用一个简单因子（如市值）跑通全流程，确认结果合理
- 绩效指标计算结果和手动计算一致

---

## 模块四：经典因子实现（Day 9-13）

**目标：** 逐个实现 5 个经典因子（A 股）+ 加密市场因子，每个因子用模块三的框架一键分析

> 对应理论：因子 Day 4-8（每个因子的定义、构造方法、经济学逻辑）

### Day 9：市值因子（Size）

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 构造市值因子：ln(流通市值)。做预处理 → IC 分析 → 分组回测。观察小盘股是否确实跑赢大盘股 | 因子 Day 4（规模因子 SMB） |
| 1h | 分时段回测：分别看 2015 年前、2016-2019 年、2020 年至今市值因子的表现变化。讨论：注册制改革后小盘股效应是否减弱？ | 因子 Day 4 |

### Day 10：价值因子（Value）

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 构造 BP（账面市值比 = 每股净资产 / 股价）和 EP（每股收益 / 股价）。注意：使用最近一期**已公布**的财报数据，避免前视偏差 | 因子 Day 5（价值因子 HML） |
| 1h | 分别对 BP、EP 做 IC 分析和分组回测。对 BP 做行业中性化处理，对比中性化前后效果。将 BP 和 EP 等权合成综合价值因子 | 因子 Day 5 + Day 6（行业中性化） |

### Day 11：动量因子与反转因子

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 构造动量因子 MOM_12_1（过去 12 个月收益率，跳过最近 1 个月）和反转因子 REV_1M（-过去 1 个月收益率）。分别做 IC 分析和分组回测 | 因子 Day 6（动量因子 UMD） |
| 1h | 对比不同回看窗口（MOM_3_1、MOM_6_1、MOM_12_1）的效果。验证 A 股的"动量弱、反转强"现象。找到动量因子表现最差的月份，分析市场环境 | 因子 Day 6 |

### Day 12：盈利因子与换手率因子

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 构造盈利因子 ROE_TTM（最近 4 个季度 ROE 之和）。构造换手率因子（-过去 20 日平均换手率，低换手率为正）。分别做全套分析 | 因子 Day 7-8 |
| 1h | 计算所有已实现因子（市值、价值、动量、反转、盈利、换手率）两两之间的截面相关系数矩阵，用热力图可视化。讨论哪些因子高度相关、哪些提供独立信息 | 因子 Day 10（因子相关性） |

### Day 13：加密市场因子

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 构造加密市场因子：市值因子（ln 市值）、动量因子（MOM_30_7，加密市场节奏更快）、成交量变化率因子。用模块三框架做全套分析 | 因子 Day 8（加密市场因子） |
| 1h | 对比 A 股和加密市场的因子表现差异：IC 均值、IC_IR、多空夏普比率。讨论：哪些因子在加密市场更有效？加密市场因子研究的特殊挑战（数据短、生存偏差严重、波动大） | 因子 Day 8 |

**做完能验证：**
- 每个因子都有完整的 Jupyter Notebook 报告（IC 统计表 + IC 时序图 + 分组净值曲线 + 绩效表）
- 因子相关矩阵热力图清晰展示因子间关系
- A 股和加密市场各有一套因子研究结果

---

## 模块五：多因子模型与回测（Day 14-17）

**目标：** 把多个因子合成综合得分，构建完整的回测框架

> 对应理论：因子 Day 9-12（多因子模型、因子合成、回测方法论、绩效评估）

### Day 14：因子合成

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 实现三种因子合成方法：(1) 等权合成，(2) 滚动 IC 加权（过去 12 个月 IC 均值作为权重），(3) IC_IR 加权。每种方法产出一个综合因子 | 因子 Day 10（因子合成） |
| 1h | 对三种综合因子分别做 IC 分析和分组回测，横向对比。讨论：哪种方法更稳定？等权是不是"够用了"？ | 因子 Day 10 |

### Day 15：Fama-MacBeth 回归实现

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 实现 Fama-MacBeth 两步回归：第一步每月做截面回归（收益率 ~ 各因子），第二步对回归系数取时间序列均值并做 t 检验。用 Newey-West 调整标准误 | 因子 Day 3 + 数学 Day 6-7 |
| 1h | 解读 Fama-MacBeth 结果：哪些因子的风险溢价显著？系数的经济含义是什么？和 IC 分析的结论是否一致？ | 因子 Day 3 |

### Day 16：回测框架（含交易成本）

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 实现完整的月度调仓回测框架：每月末根据综合因子得分选股（前 N 只）→ 确定权重（等权）→ 计算下月收益 → 扣除交易成本（佣金万 3 + 印花税千 1 + 滑点万 5）→ 计算换手率 | 因子 Day 11（回测流程） |
| 1h | 加入回测陷阱检查：确认没有前视偏差（财报发布滞后）、没有生存偏差（使用历史成分股）。对比有/无交易成本下策略的绩效差异 | 因子 Day 11（回测偏差） |

### Day 17：绩效评估与归因

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 对完整策略计算全套绩效指标，输出标准报告：净值曲线（vs 沪深 300）、月度收益柱状图、回撤曲线、年度绩效表 | 因子 Day 12（绩效评估） |
| 1h | 实现简单的因子归因：用多因子回归将策略超额收益分解到各因子上——超额收益来自市值暴露、价值暴露还是动量暴露？ | 因子 Day 12（收益归因） |

**做完能验证：**
- 等权合成 vs IC 加权合成有明确的对比数据
- Fama-MacBeth 回归结果和 IC 分析互相印证
- 回测框架包含交易成本，结果是"可信的"而不是"自欺欺人的"
- 能说清楚策略的收益到底来自哪个因子

---

## 模块六：组合构建与完整策略（Day 18-20）

**目标：** 从因子得分到可交易的投资组合，跑通完整链路

> 对应理论：因子 Day 13-14（组合构建、约束条件、完整整合）

### Day 18：组合优化

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 实现均值-方差优化选股：用因子得分作为期望收益的代理变量，用收缩协方差矩阵，加入约束（权重非负、单只 ≤ 5%、权重之和 = 1）。对比等权 vs 优化权重的回测结果 | 因子 Day 13 + 数学 Day 9 |
| 1h | 实现行业中性约束（各行业权重和基准一致）和换手率约束（月换手率 ≤ 50%）。体验"约束越多，回测越差但越真实" | 因子 Day 13 |

### Day 19：完整策略——端到端

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 把所有模块串起来跑一遍完整流程：数据加载 → 因子计算 → 预处理 → IC 检验 → 因子合成 → 选股 → 权重优化 → 回测 → 绩效评估 → 归因。一个 Notebook 从头到尾 | 因子 Day 14（完整链路） |
| 1h | 参数敏感性分析：调整持仓数量（30/50/100）、调仓频率（月度/双周）、因子合成方法，观察策略绩效的稳定性。确认策略不是对某组特定参数过拟合 | 因子 Day 11（过拟合） |

### Day 20：代码整理与策略报告

| 时间 | 内容 | 对应理论 |
|------|------|---------|
| 1h | 代码重构：将所有可复用代码整理为模块——`data/`（数据获取与清洗）、`factors/`（因子构造）、`analysis/`（IC + 分组回测）、`backtest/`（回测框架）、`portfolio/`（组合优化）、`utils/`（绩效指标 + 可视化） | — |
| 1h | 撰写最终策略报告（Jupyter Notebook）：策略逻辑、因子描述、A 股 + 加密的回测结果、风险归因、局限性讨论、下一步方向 | 因子 Day 14 |

**做完能验证：**
- 有一个结构清晰、可维护的代码仓库
- 完整策略在 A 股上有回测结果（含交易成本）
- 策略报告能向别人清楚解释"这个策略在做什么、为什么有效、风险是什么"
- 对任意新因子，只需在 `factors/` 下加一个函数，即可复用整套分析框架

---

## 不需要做的

| 内容 | 跳过原因 |
|------|---------|
| 实盘交易系统 | 本阶段只做回测研究，实盘是下一步 |
| 高频数据处理 | 因子投资是月频/周频，不涉及 tick 数据 |
| 机器学习因子合成 | XGBoost/LightGBM 等需要额外知识，作为进阶方向 |
| 事件驱动回测引擎 | 向量化回测足够，事件驱动引擎过度工程 |
| Web 界面 / Dashboard | 代码能跑就行，不需要前端 |
| 数据库（MySQL/MongoDB） | CSV/Parquet 足以应对本阶段的数据量 |

---

## 每天产出的 Notebook 清单

| Day | Notebook | 核心内容 |
|-----|----------|---------|
| 1 | `01_环境搭建与A股数据.ipynb` | 数据获取、存储 |
| 2 | `02_加密数据与统一接口.ipynb` | ccxt、数据架构 |
| 3 | `03_收益率计算与数据清洗.ipynb` | 收益率、肥尾、ST 处理 |
| 4 | `04_回归分析与假设检验.ipynb` | CAPM 回归、多重检验演示 |
| 5 | `05_PCA与优化基础.ipynb` | PCA、有效前沿 |
| 6 | `06_因子预处理.ipynb` | 去极值、标准化、行业中性 |
| 7 | `07_IC分析模块.ipynb` | IC 计算、可视化 |
| 8 | `08_分组回测与绩效指标.ipynb` | 分组回测框架、绩效函数 |
| 9 | `09_市值因子研究.ipynb` | Size 因子完整报告 |
| 10 | `10_价值因子研究.ipynb` | BP、EP、行业中性化 |
| 11 | `11_动量与反转因子研究.ipynb` | MOM、REV、窗口对比 |
| 12 | `12_盈利与换手率因子研究.ipynb` | ROE、换手率、因子相关矩阵 |
| 13 | `13_加密市场因子研究.ipynb` | 加密因子、A 股 vs 加密对比 |
| 14 | `14_因子合成方法对比.ipynb` | 等权、IC 加权、IC_IR 加权 |
| 15 | `15_Fama-MacBeth回归.ipynb` | 两步回归实现 |
| 16 | `16_回测框架.ipynb` | 月度调仓、交易成本 |
| 17 | `17_绩效评估与归因.ipynb` | 净值曲线、因子归因 |
| 18 | `18_组合优化.ipynb` | 均值方差、约束条件 |
| 19 | `19_完整策略端到端.ipynb` | 全流程串联、参数敏感性 |
| 20 | `20_最终策略报告.ipynb` | 总结报告 |

---

## 代码仓库最终结构

```
factor-investing-study/
├── code/
│   ├── notebooks/          # 每日 Jupyter Notebook
│   │   ├── 01_环境搭建与A股数据.ipynb
│   │   ├── ...
│   │   └── 20_最终策略报告.ipynb
│   ├── data/               # 数据获取与清洗模块
│   │   ├── loader.py       # 统一数据加载接口
│   │   ├── astock.py       # A 股数据获取
│   │   └── crypto.py       # 加密数据获取
│   ├── factors/            # 因子构造模块
│   │   ├── preprocess.py   # 去极值、标准化、中性化
│   │   ├── size.py         # 市值因子
│   │   ├── value.py        # 价值因子
│   │   ├── momentum.py     # 动量/反转因子
│   │   ├── quality.py      # 盈利因子
│   │   ├── turnover.py     # 换手率因子
│   │   ├── crypto.py       # 加密因子
│   │   └── composite.py    # 因子合成
│   ├── analysis/           # 因子分析模块
│   │   ├── ic.py           # IC 分析
│   │   ├── group_backtest.py  # 分组回测
│   │   └── fama_macbeth.py # Fama-MacBeth 回归
│   ├── backtest/           # 回测框架
│   │   └── engine.py       # 月度调仓回测引擎
│   ├── portfolio/          # 组合构建模块
│   │   └── optimizer.py    # 均值方差、风险平价
│   └── utils/              # 工具函数
│       ├── metrics.py      # 绩效指标
│       └── plot.py         # 可视化模板
├── data/                   # 原始数据和清洗后数据
│   ├── raw/
│   └── processed/
├── 金融知识/
├── 数学复习/
├── 因子投资/
└── 编程实践/
```

---

## 后续衔接

编程实践 20 天完成后，进入：
- **实盘模拟**：选择一个市场（A 股或加密），用模拟盘运行策略
- **进阶方向**：机器学习因子合成（XGBoost/LightGBM）、另类数据（链上数据、舆情）、因子择时
- **加密深化**：DeFi 因子（TVL、协议收入）、资金费率策略、跨交易所套利
